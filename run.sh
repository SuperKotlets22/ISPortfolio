#!/bin/bash

# Название исполняемого файла
APP="./ISPortfolio_Desktop"

echo "========================================="
echo "   ЗАПУСК СИСТЕМЫ ПОРТФОЛИО ИБ"
echo "========================================="

# 1. Проверка: Скомпилирован ли проект?
if [ ! -f "$APP" ]; then
    echo "❌ ОШИБКА: Исполняемый файл '$APP' не найден!"
    echo "Сначала откройте проект в Qt Creator и нажмите 'Собрать' (Молоток)."
    read -p "Нажмите Enter для выхода..."
    exit 1
fi

# 2. Выдаем права на исполнение
chmod +x "$APP"

echo "[0/3] Очистка старых сессий..."

sudo docker rm -f is_portfolio_db 2>/dev/null
# Также сбрасываем состояние через compose
sudo docker-compose down 2>/dev/null

# 3. Запуск Docker
echo "[1/3] Поднятие контейнера базы данных..."
if ! sudo docker-compose up -d; then
    echo "❌ ОШИБКА: Не удалось запустить Docker."
    echo "Убедитесь, что Docker установлен и запущен."
    read -p "Нажмите Enter для выхода..."
    exit 1
fi

# 4. Ожидание инициализации БД
echo "[2/3] Ожидание готовности PostgreSQL (3 сек)..."
sleep 3

# 5. Запуск приложения
echo "[3/3] Запуск интерфейса..."
echo "-----------------------------------------"
"$APP"

# 6. Очистка после закрытия
echo "-----------------------------------------"
echo "Приложение закрыто. Останавливаем базу данных..."
sudo docker-compose stop
echo "✅ Готово."
